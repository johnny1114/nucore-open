machine:
  environment:
    ORACLE_HOME: "/usr/lib/oracle/12.1/client64"
    PATH: "$PATH:$ORACLE_HOME/bin"
    LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$ORACLE_HOME/lib"
    NLS_LANG: "AMERICAN_AMERICA.WE8MSWIN1252"
  pre:
    - sudo curl --output /usr/local/bin/phantomjs https://s3.amazonaws.com/circle-downloads/phantomjs-2.1.1
  ruby:
    version: 2.2.4
  services:
    - docker
  timezone: "America/Chicago"

dependencies:
  cache_directories:
    - "~/instantclient_deb"
  pre:
    - bash config/circle/instantclient.sh

database:
  pre:
    - cp config/circle/database.yml config/database.yml
    - docker run -d -p 1521:1521 wnameless/oracle-xe-11g; sleep 10
    - bash config/circle/database_create.sh
  override:
    - export RAILS_ENV="test"; export RACK_ENV="test"; bundle exec rake db:schema:load

test:
  override:
    - bundle exec rspec --format RspecJunitFormatter --out $CIRCLE_TEST_REPORTS/rspec.xml --format progress:
        parallel: true
        files:
          - spec/**/*_spec.rb
          - vendor/engines/c2po/spec/**/*_spec.rb
          - vendor/engines/dataprobe/spec/**/*_spec.rb
          - vendor/engines/jxml/spec/**/*_spec.rb
          - vendor/engines/nu/spec/**/*_spec.rb
          - vendor/engines/nu_cardconnect/spec/**/*_spec.rb
          - vendor/engines/nucs/spec/**/*_spec.rb
          - vendor/engines/pmu/spec/**/*_spec.rb
          - vendor/engines/split_accounts/spec/**/*_spec.rb

  post:
    - bundle exec teaspoon
      --suppress-log
      --format junit > $CIRCLE_TEST_REPORTS/teaspoon.xml
    - bundle exec report_coverage
